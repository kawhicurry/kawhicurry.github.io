<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>分类: Operation | Kawhicurry's Blog</title><meta name="author" content="kawhicurry"><meta name="copyright" content="kawhicurry"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="引子本来只是在过xdp-tutorial的教程。里面提到了xdp并不是linux内核中唯一的ebpf network hook。另一个例子就是tc。还提到了有一种方法可以通过xdp讲metadata传递给tc。 于是顺便研究了下tc，发现这玩意是用来做流控的，而且和xdp有个很大的区别是，tc可以接"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/profile/favicon.jpg"><link rel="canonical" href="https://kawhicurry.github.io/Operation/Linux/47a3710b/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="code-UXVbU6tNCR"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-70WJTE71NM"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-70WJTE71NM');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":1000},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: kawhicurry","link":"链接: ","source":"来源: Kawhicurry's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#d8dee9","bgDark":"#2e3440","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '分类: Operation',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-02-22 21:36:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Kawhicurry's Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/profile/avatar.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">82</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/img_1293.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Kawhicurry's Blog"><span class="site-name">Kawhicurry's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">从tc开始的一次简单的内核网络栈探索</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-29T04:30:06.000Z" title="发表于 2023-10-29 12:30:06">2023-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-02-22T13:36:06.102Z" title="更新于 2025-02-22 21:36:06">2025-02-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Operation/">Operation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Operation/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="从tc开始的一次简单的内核网络栈探索"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><p>本来只是在过<a target="_blank" rel="noopener" href="https://github.com/xdp-project/xdp-tutorial">xdp-tutorial</a>的教程。<br><a target="_blank" rel="noopener" href="https://github.com/xdp-project/xdp-tutorial/tree/master/advanced01-xdp-tc-interact">里面</a>提到了xdp并不是linux内核中唯一的ebpf network hook。另一个例子就是tc。还提到了有一种方法可以通过xdp讲metadata传递给tc。</p>
<p>于是顺便研究了下tc，发现这玩意是用来做流控的，而且和xdp有个很大的区别是，tc可以接管egress，这是xdp做不到的。<br>恰好这时候遇到了一堆机缘巧合，比如@dreamlike大力夸赞宇宙厂使用tc做透明流量劫持，比如CSIG面试官的听到xdp莫得反应，但是听到tc就兴奋地考我啥是net_cls（总之是一个我听了觉得满头问号的场景），比如偶遇了以为CSIG做网络的大佬，介绍了下业界目前前沿的网络方案。</p>
<p>恰好linux网络这一块一直没补上，深知自己太菜的我只能长叹一声：“彳亍，我看，我看还不行嘛”。</p>
<h1 id="从tc开始"><a href="#从tc开始" class="headerlink" title="从tc开始"></a>从tc开始</h1><h2 id="啥是tc？"><a href="#啥是tc？" class="headerlink" title="啥是tc？"></a>啥是tc？</h2><p>先看<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc.8.html">https://man7.org/linux/man-pages/man8/tc.8.html</a></p>
<blockquote>
<pre><code>  Tc is used to configure Traffic Control in the Linux kernel.
</code></pre>
</blockquote>
<p>这句话告诉我们，内核里其实实现了traffic control的功能，而tc其实是一个userspace的命令，只是个调整内核设置的工具。那现在就有了两个最简单的问题：</p>
<ol>
<li>tc命令咋用，能干啥？</li>
<li>内核里做了什么？如何能达到traffic control的目的？</li>
</ol>
<h2 id="tc能干啥？"><a href="#tc能干啥？" class="headerlink" title="tc能干啥？"></a>tc能干啥？</h2><p>如果只是使用，网上随便搜搜就有了，请读者自行搜索。这里列举一些目前观测到的用途：</p>
<ol>
<li>限流（老本行，发明出来就是干这个的）</li>
<li>模拟网络波动、延迟等糟糕的网络环境（只适用于调试用户态程序，不必多说）</li>
<li>透明代理（没错，cilium！）</li>
<li>网卡转发（没错，bpf！）</li>
</ol>
<h2 id="tc的核心概念"><a href="#tc的核心概念" class="headerlink" title="tc的核心概念"></a>tc的核心概念</h2><p>在进一步讨论tc的实现之前，似乎有必要停下来给完全没用过tc的同学（比如两个月前的我）介绍下tc的基本概念。</p>
<p>还是看<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc.8.html">man page</a>。注意这里有三个概念：</p>
<ul>
<li>QDISCS</li>
<li>CLASSES</li>
<li>FILTERS</li>
</ul>
<p>专业的读者可以自行阅读这些概念，没用过的菜鸡（比如两个月前的我）可以先来看看我的解释。</p>
<h3 id="浅显的解释：尝试自己构建一个流控系统"><a href="#浅显的解释：尝试自己构建一个流控系统" class="headerlink" title="浅显的解释：尝试自己构建一个流控系统"></a>浅显的解释：尝试自己构建一个流控系统</h3><p>如果我们自己写一个流控系统，我们会怎么做？</p>
<p>众所周知，网络数据会以frame&#x2F;packet的形式进入linux的kernel。那我们要控制这些frame&#x2F;packet的速度该怎么做呢？没错，排队！于是我们设计出了一个很长很长的<strong>队列</strong>，然后给这个队列设计了相应的<strong>策略</strong>让进入的流量在里面排着队，然后慢慢悠悠但有条不紊的发送出去。然后我们碰到了另一个问题：所有流量都要排队嘛？</p>
<p>显然不是，如果我后台下载小电影的流量影响了我在游戏里乱杀，那我会气到把小电影都删掉的（这是虚构场景哈，我是指我没有在游戏里乱杀）。所以我们需要另一个概念：<strong>分类</strong>，把下载小电影的流量分类到受到限制的队列中，把游戏分到更加畅通的队列中。</p>
<p>接下来看看另一个问题，我们已经把游戏的流量和下载的流量区分开来，那让我们继续看看这个场景：游戏里的流量也是有分类的，有对战的流量，也有语音的流量。在一些网络环境不太好的情况下，这些流量也会互相干扰（一个更明显的案例是，网不好的时候会议软件不要开视频，不然声音会卡）。那我如何进一步对这些细分的流量做限制呢？当然，你完全可以直接再加一个分类。就像这样：</p>
<ul>
<li>电影</li>
<li>游戏语音</li>
<li>游戏对战</li>
</ul>
<p>不过树形的结构很显然要更合理一点：</p>
<ul>
<li>电影</li>
<li>游戏<ul>
<li>语音</li>
<li>对战</li>
</ul>
</li>
</ul>
<p>没错，理论上你应该允许分类规则<em>递归</em>处理这些数据，而不是把所有控制写到同一层里。</p>
<p>我们已经设计好了自己的tc，接下来我们看看linux的tc是怎么做的。</p>
<h3 id="详细的设计：tc的基本概念"><a href="#详细的设计：tc的基本概念" class="headerlink" title="详细的设计：tc的基本概念"></a>详细的设计：tc的基本概念</h3><p>tc把队列和策略合二为一，称为<code>qdisc</code>，即queueing discipline。接下来qdisc会被分成两类：<code>classful qdisc</code>和<code>classless qdisc</code>。前者本身不直接处理数据，而是通过<code>filter</code>讲数据转交给其他qdisc，这里的其他qdisc可以是直接处理数据的classless qdisc，也可以是又一个进行分类的classful qdisc。</p>
<p>关于分类，可以看看<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/advanced_traffic_control#Classful_Qdiscs">arch wiki</a></p>
<h2 id="tc命令的通信机制"><a href="#tc命令的通信机制" class="headerlink" title="tc命令的通信机制"></a>tc命令的通信机制</h2><p>虽然我计算机知识比较贫瘠，但好在C语言还是看的懂的。tc是<a target="_blank" rel="noopener" href="https://github.com/iproute2/iproute2">iproute2项目</a>的一部分。我强调我计算机知识贫瘠是因为这是我头回了解<em>内核如何与用户进程通信</em>这个话题，我花了点时间才意识到tc其实是通过<code>netlink</code>来进行通信的。</p>
<p>一开始我用 strace 来追踪 tc qdisc show 这个命令，然后发现它打开了<code>/proc/net/psched</code>这个文件，我以为它是类似cgroup那样有一个虚拟fs之类的接口。后面仔细读了代码发现应该是netlink的socket进行的通信。于是这里又有了两个问题：</p>
<ol>
<li>&#x2F;proc&#x2F;net&#x2F;psched 这个文件里有啥？</li>
<li>如何通过netlink通信呢？接口是啥样？</li>
</ol>
<h3 id="proc-net-psched"><a href="#proc-net-psched" class="headerlink" title="&#x2F;proc&#x2F;net&#x2F;psched"></a>&#x2F;proc&#x2F;net&#x2F;psched</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /proc/net/psched 
000003e8 00000040 000f4240 3b9aca00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>直接读取可以看到里面有四个数，我们看看tc是怎么读它的：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">double</span> tick_in_usec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">double</span> clock_factor <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">tc_core_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
	__u32 clock_res<span class="token punctuation">;</span>
	__u32 t2us<span class="token punctuation">;</span>
	__u32 us2t<span class="token punctuation">;</span>

	fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/proc/net/psched"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%08x%08x%08x"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>t2us<span class="token punctuation">,</span> <span class="token operator">&amp;</span>us2t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clock_res<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* compatibility hack: for old iproute binaries (ignoring
	 * the kernel clock resolution) the kernel advertises a
	 * tick multiplier of 1000 in case of nano-second resolution,
	 * which really is 1. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>clock_res <span class="token operator">==</span> <span class="token number">1000000000</span><span class="token punctuation">)</span>
		t2us <span class="token operator">=</span> us2t<span class="token punctuation">;</span>

	clock_factor  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>clock_res <span class="token operator">/</span> TIME_UNITS_PER_SEC<span class="token punctuation">;</span>
	tick_in_usec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>t2us <span class="token operator">/</span> us2t <span class="token operator">*</span> clock_factor<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以看到tc其实只读了前三个数，赋值给了三个参数 t2us,us2t,clock_res，然后用这三个数去计算出了两个全局静态变量 clock_factor 和 tick_in_usec。这两个变量又被用在哪里呢？全局搜了下，被用在这几个函数里</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">unsigned int tc_core_time2tick(unsigned int time)
&#123;
	return time*tick_in_usec;
&#125;

unsigned int tc_core_tick2time(unsigned int tick)
&#123;
	return tick&#x2F;tick_in_usec;
&#125;

unsigned int tc_core_time2ktime(unsigned int time)
&#123;
	return time * clock_factor;
&#125;

unsigned int tc_core_ktime2time(unsigned int ktime)
&#123;
    &#x2F;&#x2F; ...
&#125;

&#x2F;&#x2F; ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>似乎是一些时间相关的函数，我们挑一个函数看看被用在哪里</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F; 调用链如下
&#x2F;&#x2F; tc_core_time2tick &lt;- tc_cbq_calc_maxidl &lt;- cbq_parse_class_opt

struct qdisc_util cbq_qdisc_util &#x3D; &#123;
	.id		&#x3D; &quot;cbq&quot;,
	.parse_qopt	&#x3D; cbq_parse_opt,
	.print_qopt	&#x3D; cbq_print_opt,
	.print_xstats	&#x3D; cbq_print_xstats,
	.parse_copt	&#x3D; cbq_parse_class_opt,
	.print_copt	&#x3D; cbq_print_opt,
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>到了cbq这里可能大家会有些疑惑了，这是个啥？让我们回到<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc.8.html">官方文档</a>搜索CBQ。</p>
<blockquote>
<pre><code>  CBQ    Class Based Queueing implements a rich linksharing
         hierarchy of classes.  It contains shaping elements as
         well as prioritizing capabilities. Shaping is performed
         using link idle time calculations based on average packet
         size and underlying link bandwidth. The latter may be ill-
         defined for some interfaces.
</code></pre>
</blockquote>
<p>cbq是一种classful qdisc。也就是说所谓的open &#x2F;proc&#x2F;net&#x2F;psched只是为了取几个时间参数罢了。这几个时间参数后面会被用在创建一些类型的 qdisc 的时候，<strong>tc并不是通过fs来和内核通信的</strong>。</p>
<p>想知道这结果参数到底是啥？请自行阅读内核代码</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F; net&#x2F;sched&#x2F;sch_api.c
static int psched_show(struct seq_file *seq, void *v)
&#123;
	seq_printf(seq, &quot;%08x %08x %08x %08x\n&quot;,
		   (u32)NSEC_PER_USEC, (u32)PSCHED_TICKS2NS(1),
		   1000000,
		   (u32)NSEC_PER_SEC &#x2F; hrtimer_resolution);

	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Netlink"><a href="#Netlink" class="headerlink" title="Netlink"></a>Netlink</h3><p>先来看看<a target="_blank" rel="noopener" href="https://docs.kernel.org/userspace-api/netlink/intro.html">官方文档</a>是怎么说的：</p>
<blockquote>
<p>Netlink is often described as an ioctl() replacement. It aims to replace fixed-format C structures as supplied to ioctl() with a format which allows an easy way to add or extended the arguments.</p>
</blockquote>
<p>好，看看<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/ioctl.2.html">ioctl</a></p>
<blockquote>
<p>The ioctl() system call manipulates the underlying device<br>   parameters of special files.</p>
</blockquote>
<p>看不懂了，总之就是和长得像文件的硬件通信？等等，netlink是socket，那不就和别的socket差不多？比如ipv4的和v6的或者unix的？</p>
<p>算了，看点轻松的吧。这是我当时提出来的问题，如果tc不是通过fs这种方式和内核沟通，也完全看不到相关的syscall，那还有哪些方式呢？于是我 google 了下这个问题 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20975566/what-is-the-best-way-to-communicate-a-kernel-module-with-a-user-space-program">What is the best way to communicate a kernel module with a user space program?</a></p>
<p>好家伙，原来还有种通信方式叫netlink，头回知道（狗头）。于是在源码里搜索栏下<code>AF_NETLINK</code>，可以确定tc命令就是通过netlink与内核模块进行通信的了。</p>
<h3 id="tc的一些有趣的功能"><a href="#tc的一些有趣的功能" class="headerlink" title="tc的一些有趣的功能"></a>tc的一些有趣的功能</h3><p>本来这里是打算花长篇大论描述一下tc子系统是如何实现的，尤其是各种队列的设置。但是在中间的学习过程中突然了解到现代的linux网络早就认为“基于排队的发送”已经过时了，更高效的方案是“基于时间的发送”，即EDT。同时我还发现tc只是整个网络栈中很小的一环，我已经等不及去探索更深的地方了。</p>
<p>因此我决定不要在这样一个小工具上花太多时间去给其他读者重复这些可能没有太多用途的东西。但是既然决定开始写一篇这样的博客，那就还是要有头有尾。<br>这里记录一些tc有趣的功能，如果读者感兴趣，不妨自己去探索。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc-bpf.8.html">tc-bpf</a> 没错，可以把bpf代码注入到tc提供的hook中，这是一个比xdp靠后得多的位置。我们所熟知的cilium就是在这里做了一大堆工作。</li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc-pedit.8.html">tc-pedit</a> tc允许注入一个叫做<code>pedit</code>的action用于修改packet的内容。评价是不如ebpf，ebpf可以直接改。</li>
</ul>
<h3 id="一些关于tc的疑惑"><a href="#一些关于tc的疑惑" class="headerlink" title="一些关于tc的疑惑"></a>一些关于tc的疑惑</h3><p>快问快答：</p>
<h4 id="tc工作在哪一层？"><a href="#tc工作在哪一层？" class="headerlink" title="tc工作在哪一层？"></a>tc工作在哪一层？</h4><p>网络层，在netfilter前面，tap设备处理后面。因此，tc没有conntrack的相关功能。</p>
<h4 id="tc拿到的数据是啥样的？"><a href="#tc拿到的数据是啥样的？" class="headerlink" title="tc拿到的数据是啥样的？"></a>tc拿到的数据是啥样的？</h4><p>确切的说，是一个以太网的<code>帧</code>.有兴趣可以看看<a target="_blank" rel="noopener" href="https://davidlovezoe.club/wordpress/archives/952">这篇文章</a>，写的相当清晰。其实写一个注入到tc中的ebpf代码没啥难的，只要你能理解如何用kernel header中的struct来解析网络协议中各层的header就行。</p>
<h4 id="tc的内核配置只能用tc命令实现嘛？"><a href="#tc的内核配置只能用tc命令实现嘛？" class="headerlink" title="tc的内核配置只能用tc命令实现嘛？"></a>tc的内核配置只能用tc命令实现嘛？</h4><p>当然不是，上面已经说过tc命令也是通过netlink通信，所以直接使用netlink通信就行了，可以模仿tc命令写c，也可以调用下别人的相关库，比如这个：<a target="_blank" rel="noopener" href="https://github.com/florianl/go-tc">go-tc</a></p>
<h4 id="cilium怎么讲ebpf命令注入到tc内核模块中呢？"><a href="#cilium怎么讲ebpf命令注入到tc内核模块中呢？" class="headerlink" title="cilium怎么讲ebpf命令注入到tc内核模块中呢？"></a>cilium怎么讲ebpf命令注入到tc内核模块中呢？</h4><p>参考<a target="_blank" rel="noopener" href="https://github.com/cilium/cilium/blob/ba6c6612645bee766e303570f346c9f7c48d1e52/pkg/datapath/loader/netlink.go#L207">源码</a>，cilium直接调用了第三方的netlink库来执行注入。可以说是非常好用。</p>
<h3 id="linux-RX"><a href="#linux-RX" class="headerlink" title="linux RX"></a>linux RX</h3><p>如我在上面所说，tc只是网络栈众多子系统中的一个，更大的世界等着我们去探索。下面这篇文章可以让我们对于整个RX有一个大概的认知，但想要了解整个linux网络栈的工作方式，要做的工作恐怕还有很多。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/linux-net-stack-implementation-rx-zh/#736-tc-%E5%A4%84%E7%90%86">http://arthurchiao.art/blog/linux-net-stack-implementation-rx-zh/#736-tc-%E5%A4%84%E7%90%86</a></li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc.8.html">https://man7.org/linux/man-pages/man8/tc.8.html</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/advanced_traffic_control#Classful_Qdiscs">https://wiki.archlinux.org/title/advanced_traffic_control#Classful_Qdiscs</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://kawhicurry.github.io">kawhicurry</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kawhicurry.github.io/Operation/Linux/47a3710b/">https://kawhicurry.github.io/Operation/Linux/47a3710b/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kawhicurry.github.io" target="_blank">Kawhicurry's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/linux/">linux</a><a class="post-meta__tags" href="/tags/tc/">tc</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-62037f9d1c65c8d1" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Daily/41551188/" title="daily-2024-07-07"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/IMG_1217.JPG" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">daily-2024-07-07</div></div></a></div><div class="next-post pull-right"><a href="/Tools/35816fcf/" title="给飞扬哥的博客上传指南"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/DSC_9980.JPG" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">给飞扬哥的博客上传指南</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/Auto/5e6b7330/" title="ROS学习笔记（0）"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/DSC_0145.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">ROS学习笔记（0）</div></div></a></div><div><a href="/Auto/f462bbbb/" title="ROS学习笔记（2）"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/DSC_0143.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-21</div><div class="title">ROS学习笔记（2）</div></div></a></div><div><a href="/Auto/4cdedcde/" title="ROS学习笔记（3）"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/IMG_1217.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-23</div><div class="title">ROS学习笔记（3）</div></div></a></div><div><a href="/Language/Cpp/b1a7294/" title="APUE（0）"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/DSC_9980.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-06</div><div class="title">APUE（0）</div></div></a></div><div><a href="/Language/Cpp/b3a615f1/" title="APUE（1）"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/IMG_1217.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-06</div><div class="title">APUE（1）</div></div></a></div><div><a href="/Language/Cpp/a113ba1f/" title="APUE（2）"><img class="cover" src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/img_1293.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-11</div><div class="title">APUE（2）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/profile/avatar.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="avatar"/></div><div class="author-info__name">kawhicurry</div><div class="author-info__description">An student aiming to be an operation engineer.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">82</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kawhicurry"><i class="fab fa-github"></i><span>逛逛博主的github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kawhicurry" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:kawhicurry@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://kawhicurry.github.io/atom.xml" target="_blank" title="Rss"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">我们一天天所度过的所谓日常,可能是接连不断的奇迹</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E5%AD%90"><span class="toc-number">1.</span> <span class="toc-text">引子</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8Etc%E5%BC%80%E5%A7%8B"><span class="toc-number">2.</span> <span class="toc-text">从tc开始</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%A5%E6%98%AFtc%EF%BC%9F"><span class="toc-number">2.1.</span> <span class="toc-text">啥是tc？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tc%E8%83%BD%E5%B9%B2%E5%95%A5%EF%BC%9F"><span class="toc-number">2.2.</span> <span class="toc-text">tc能干啥？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tc%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.3.</span> <span class="toc-text">tc的核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%98%BE%E7%9A%84%E8%A7%A3%E9%87%8A%EF%BC%9A%E5%B0%9D%E8%AF%95%E8%87%AA%E5%B7%B1%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%B5%81%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.3.1.</span> <span class="toc-text">浅显的解释：尝试自己构建一个流控系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E7%9A%84%E8%AE%BE%E8%AE%A1%EF%BC%9Atc%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.3.2.</span> <span class="toc-text">详细的设计：tc的基本概念</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tc%E5%91%BD%E4%BB%A4%E7%9A%84%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">tc命令的通信机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#proc-net-psched"><span class="toc-number">2.4.1.</span> <span class="toc-text">&#x2F;proc&#x2F;net&#x2F;psched</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netlink"><span class="toc-number">2.4.2.</span> <span class="toc-text">Netlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tc%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">2.4.3.</span> <span class="toc-text">tc的一些有趣的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%85%B3%E4%BA%8Etc%E7%9A%84%E7%96%91%E6%83%91"><span class="toc-number">2.4.4.</span> <span class="toc-text">一些关于tc的疑惑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tc%E5%B7%A5%E4%BD%9C%E5%9C%A8%E5%93%AA%E4%B8%80%E5%B1%82%EF%BC%9F"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">tc工作在哪一层？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tc%E6%8B%BF%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E6%98%AF%E5%95%A5%E6%A0%B7%E7%9A%84%EF%BC%9F"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">tc拿到的数据是啥样的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tc%E7%9A%84%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE%E5%8F%AA%E8%83%BD%E7%94%A8tc%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0%E5%98%9B%EF%BC%9F"><span class="toc-number">2.4.4.3.</span> <span class="toc-text">tc的内核配置只能用tc命令实现嘛？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cilium%E6%80%8E%E4%B9%88%E8%AE%B2ebpf%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E5%88%B0tc%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%91%A2%EF%BC%9F"><span class="toc-number">2.4.4.4.</span> <span class="toc-text">cilium怎么讲ebpf命令注入到tc内核模块中呢？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-RX"><span class="toc-number">2.4.5.</span> <span class="toc-text">linux RX</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/AI/47184172/" title="第一次LLM学习之旅"><img src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/DSC_0143.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第一次LLM学习之旅"/></a><div class="content"><a class="title" href="/AI/47184172/" title="第一次LLM学习之旅">第一次LLM学习之旅</a><time datetime="2025-02-22T13:36:06.099Z" title="发表于 2025-02-22 21:36:06">2025-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Auto/6b018282/" title="自动化的讽刺"><img src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/IMG_1214.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自动化的讽刺"/></a><div class="content"><a class="title" href="/Auto/6b018282/" title="自动化的讽刺">自动化的讽刺</a><time datetime="2025-02-22T08:41:40.000Z" title="发表于 2025-02-22 16:41:40">2025-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Tools/undefined/" title="lock教程"><div style="background: https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/img_1327.jpg"></div></a><div class="content"><a class="title" href="/Tools/undefined/" title="lock教程">lock教程</a><time datetime="2025-02-15T06:08:14.000Z" title="发表于 2025-02-15 14:08:14">2025-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Daily/41551188/" title="daily-2024-07-07"><img src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/IMG_1217.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="daily-2024-07-07"/></a><div class="content"><a class="title" href="/Daily/41551188/" title="daily-2024-07-07">daily-2024-07-07</a><time datetime="2024-07-06T16:34:01.000Z" title="发表于 2024-07-07 00:34:01">2024-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Operation/Linux/47a3710b/" title="从tc开始的一次简单的内核网络栈探索"><img src="https://cdn.jsdelivr.net/gh/kawhicurry/picgo/gallery/nord/img_1293.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从tc开始的一次简单的内核网络栈探索"/></a><div class="content"><a class="title" href="/Operation/Linux/47a3710b/" title="从tc开始的一次简单的内核网络栈探索">从tc开始的一次简单的内核网络栈探索</a><time datetime="2023-10-29T04:30:06.000Z" title="发表于 2023-10-29 12:30:06">2023-10-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/kawhicurry/picgo/nordic/nord_alone_tree.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By kawhicurry</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Welcome to the world of an growing SRE.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '528affc74d9344c23daf',
      clientSecret: '41afe1cad2849c60940bd386fe0bbda659a73a16',
      repo: 'kawhicurry.github.io.comment',
      owner: 'kawhicurry',
      admin: ['kawhicurry'],
      id: '65582eae37c11b109b619eb1ddabd395',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>